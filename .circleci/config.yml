version: 2.1
orbs:
  node: twuni/nodejs@12.10.0
machine:
  environment:
    DOWNLOADS_PATH: '$HOME/downloads'
    YARN_PATH: '$HOME/.yarn'
    YARN_VERSION: 1.19.0
    PATH: '${PATH}:${HOME}/.yarn/bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/client/node_modules/.bin'
  post:
    - mkdir -p $DOWNLOADS_PATH
    - mkdir -p $YARN_PATH
jobs:
  build-and-test:
    executor:
      name: node/default
    steps:
      - checkout
      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}
      - run:
          name: Install Dependencies
          command: yarn install --frozen-lockfile
      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - node/with-cache:
          steps:
            - run: cd client
            - run: yarn install
            - run: yarn test
workflows:
  build-and-test:
    jobs:
      - build-and-test
dependencies:
  pre:
    - ./bin/install-yarn
  cache_directories:
    - ~/downloads
    - ~/.cache/yarn
    - ~/.yarn
  override:
    - yarn install
    - ./bin/update-docker
